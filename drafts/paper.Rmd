---
title: "simr: an R Package for Power Analysis of Linear Mixed Models by Simulation"
output: html_document
---

The tutorial from the paper --- just the R bits.

```{r load, message=FALSE}
library(simr)
set.seed(123)
```

```{r options, echo=FALSE, message=FALSE}
simrOptions(nsim=1000, progress=FALSE)
```

```{r knitr, echo=FALSE}
library(knitr)
opts_knit$set(root.dir = "..")
opts_chunk$set(dev=c("svg", "png", "pdf"))
opts_chunk$set(cache.extra = simrOptions())
```

## Example Data

```{r example, echo=FALSE}
fgcol <- c(a=simr:::lcrgreen, b=simr:::lcrblue, c=simr:::lcrbrown)
bgcol <- simr:::lighten(fgcol)
plot(example$x, example$z,
    #ylim = c(0, 20),
    #lwd = 2,
    pch = 21,
    col = fgcol[example$g],
    bg = bgcol[example$g],
    cex.lab = 2
    )
#tmp <- mapply(abline, 10+unique(example$z), -1/4, col=fgcol, lty=4)
```

## Section One

"Power analysis in three lines".

```{r three, eval=FALSE}
model1 <- glmer(z ~ x + (1|g), family="poisson", data=example)
fixef(model1)["x"] <- -0.05
powerSim(model1)
```

### Fit the model

```{r model}
model1 <- glmer(z ~ x + (1|g), family="poisson", data=example)
summary(model1)
```

### Specify the effect size

````{r fixef1}
fixef(model1)
fixef(model1)["x"]
fixef(model1)["x"] <- -0.05
fixef(model1)
```

### Calculate power

```{r powersim1, cache=TRUE, autodep=TRUE}
powerSim(model1)
```

### Oops

```{r oops, eval=FALSE}
ps <- lastResult()
```

## Section Two

Use `extend` to increase the sample size.

```{r extend1, cache=TRUE, autodep=TRUE}
model2 <- extend(model1, along="x", n=20)
powerSim(model2)
```

## Section Three

Power curve over range of sample sizes.

```{r powercurve1, cache=TRUE, autodep=TRUE}
pc2 <- powerCurve(model2)
print(pc2)
plot(pc2)
```

## Section Four

Increase the number or size of groups.

### Part 1

Power curve with more groups.

```{r powercurve4a, cache=TRUE, autodep=TRUE}
model4a <- extend(model1, along="g", n=15)
powerCurve(model4a, along="g")
plot(lastResult())
```

### Part 2

Power curve with larger groups.

```{r powercurve4b, cache=TRUE, autodep=TRUE}
#model4b <- extend(model1, within="x+g", n=5)
example$repl <- 1
model4b <- glmer(z ~ x + (1|g), family="poisson", data=example)
fixef(model4b)["x"] <- -0.05
model4b <- extend(model4b, along="repl", n=5)
powerCurve(model4b, along="repl", breaks=1:5)
plot(lastResult())
```
