Introduction to Simm
====================

If we are going to invest in the collection of monitoring data, it is important that we know that our design is suitable for making the inferences we need. Does the design have sufficient power to detect what we are trying to find? Are our parameter estimates going to be precise enough for our purposes? 

When the design is complicated, e.g. in a mixed-effects model, simulation provides a general way of answering these questions. The `simm` package provides tools that make it simple to set up and run simulation experiments. 

Installation
------------

### Using `devtools` to install the new `lme4`

`simm` is based on the new (as yet unreleased) version of `lme4`.

```{r}
library(devtools)
#dev_mode(on=TRUE)
#library(lme4)
```

### Installing `simm`

```{r, eval=FALSE}
install.packages('simm.tar.gz', repos=NULL, type='source')
```

### Other packages for this tutorial

```{r}
library(xtable)
options(width=100)
```

Load the package
----------------

Once you have installed `simm`, it can be loaded from your library in the usual way.

```{r, eval=FALSE}
library(simm)
```

```{r, eval=FALSE}
load_all(, reset=TRUE)
```

```{r}
load_all('..', reset=TRUE)
```

The kiwifruit dataset
---------------------

This data was collected as part of the ARGOS soil monitoring pilot.

The pilot study collected measurements in each of three years, 2004, 2006, and 2009[^1].

```{r}
head(kiwifruit[, 1:6], 10)
head(kiwifruit[, 7:12], 10)
```

```{r results='asis', echo=FALSE}
print(xtable(head(kiwifruit, 10)), type='html', include.rownames=FALSE, html.table.attributes = getOption("xtable.html.table.attributes"))
```

[^1]: Data labelled 2009 was actually collected over two years 2009/10. We intend to use the actual year of collection in the final version.

Fit a linear mixed model
------------------------

```{r}
#kiwifruit <- within(kiwifruit, Year <- Year - 2006)
fit <- lmer(Carbon ~ Position * Mgmt + Year + (Year | Cluster/Mgmt/Block), kiwifruit)
print(fit)
```

Extend longitudinal data
------------------------

For each of the three years there should be 216 observations --- 12 clusters x 3 management types x 3 blocks x 2 positions.

```{r}
nrow(subset(kiwifruit, Year==2004))
nrow(subset(kiwifruit, Year==2006))
nrow(subset(kiwifruit, Year==2009))
```

```{r}
seq(2014, 2039, length=6)
```

```{r}
yseq <- seq(2014, 2039, length=6)
xfit <- extend(fit, along='Year', values=yseq)
#xfit <- extend(fit, along='Year', values=seq(-3, 3))
dim(xfit@frame)
```

Setting the red-alert trend
---------------------------

We would like our monitoring effort to have enough power to detect an industry-wide trend in soil carbon of -0.13 (units). However, if we simulate from the fitted model the "true" trend would be `r fixef(xfit)['Year']`. `simm` lets us modify the fixed effect coefficients in our fitted models.

```{r}
#fixef(xfit)['Year'] <- -0.13
fixef(xfit)['Year'] <- -0.013
fixef(xfit)
```

TODO: set variance components.


Creating simulated data
-------------------------

```{r}
Nsim <- 100
sims <- simulate(xfit, Nsim)
```

Running the simulation
----------------------

```{r}
results <- multiFit(resp=sims, model=xfit, fn=test('Year', 'lower'))
```


Viewing the results
-------------------

```{r}
pwr <- colMeans(results < 0.05)
powerPlot(colSums(results < 0.05), Nsim)
pwr
```


First Header | Second Header
------------ | -------------
Content      | Content
Content      | Content